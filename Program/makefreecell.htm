<html>

<head>
<meta http-equiv="Content-Language" content="zh-cn">
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>空当接龙工具是怎样炼成的</title>
<base target="_self">
</head>

<body bgcolor="#FFD099">

<p style="line-height: 150%"><font color="#008000">&nbsp;&nbsp;&nbsp; 
这篇文章发表于2000年《程序员》杂志试刊号。空当接龙工具是在1999年写出来的，那时的我，程序技术比不上现在，但是热情却高很多。现在如果要我解决这个问题，上网一搜，找出现成的工具和源代码，也许就没有动力自己动手写了吧。</font></p>
<p style="line-height: 150%">　</p>
<p style="line-height: 150%"><font color="#008000">&nbsp;&nbsp;&nbsp; 
从0.1到1.0――空当接龙工具是怎样炼成的<br>
<br>
&nbsp;&nbsp;&nbsp; 
空当接龙工具是一个非常漂亮的软件，能够自动读取空当接龙游戏程序的当前状态，求解之，并以非常清晰的图解方式把解题方法显示出来。最绝的是它能够操作空当接龙游戏！当你观看解答时，不必频繁切换到空当接龙游戏，可以选择让软件自己操作，使得游戏的进程与解答的进程同步。也可以让软件自己自动连续求解几百局，使得你的空当接龙的“战况”中显示出惊人的记录。<br>
&nbsp;&nbsp;&nbsp; 
空当接龙工具的当前最高版本是1.1版，包括在软件集“扫雷接龙魔术师”中。该软件集中还有另外两个小东西：自动扫雷和扫雷俄罗斯（强烈建议每个爱好扫雷的玩家来玩一玩这个小游戏）。<br>
空当接龙工具公开发表的第一版是1.0版，是在99年3月份的事。很多用户给我来信说：“简直是太奇妙了，你一定是个天才！”其实我不是天才，为了证明这一点，我只好掏出秘而不宣的空当接龙工具0.1版，让大家看看一个软件是怎么写出来的。<br>
&nbsp;&nbsp;&nbsp; 空当接龙工具0.1版是一个在Win95下运行的Dos程序。当你运行它时，一句话也不说，跳出一个记事本窗口，里面写着：<br>
<br>
; FreeCell Tool input file.<br>
; GameID: <br>
;Please write 8 lines according to 8 columns.<br>
;S(pade),H(eart),D(iamond),C(lub) stand for kinds.<br>
;1-9,0(for card 10),J,Q,K stand for card numbers.<br>
;use space to separate cards.<br>
;for example, D3 HK C0 ...<br>
1 column(7 cards): <br>
2 column(7 cards): <br>
3 column(7 cards): <br>
4 column(7 cards): <br>
5 column(6 cards): <br>
6 column(6 cards): <br>
7 column(6 cards): <br>
8 column(6 cards): <br>
<br>
&nbsp;&nbsp;&nbsp; 然后，用户就得自己把牌局给输入进去。输入好的文本看起来是这样的：<br>
<br>
......<br>
1 Column(7 Dards): C0 h6 Dq Ck D9 Dj h9<br>
2 Column(7 Dards): h0 D0 s4 hq C6 h8 hk<br>
3 Column(7 Dards): C8 h3 C7 Dk h1 D6 h2<br>
4 Column(7 Dards): D7 C3 hj D2 C1 D4 s2<br>
5 Column(6 Dards): sq C9 h4 s5 D8 D1<br>
6 Column(6 Dards): s3 s1 h5 h7 C5 sj<br>
7 Column(6 Dards): D3 s6 sk Cq D5 s8<br>
8 Column(6 Dards): C4 s9 s0 C2 Cj s7<br>
<br>
&nbsp;&nbsp;&nbsp; 是不是看起来很专业的样子？然后存盘退出记事本，工具程序于是说：<br>
<br>
Game input OK!<br>
Now searching...<br>
<br>
&nbsp;&nbsp;&nbsp; 几十秒后：<br>
<br>
Find answer! (Total 86 steps.)<br>
( 1) Move Diamond 1 To HomeCell;<br>
( 2) Move Spade 7 To Diamond 8;<br>
( 3) Move Spade 8 To Heart 9;<br>
( 4) Move Heart 2 To FreeCell;<br>
( 5) Move Diamond 6 To Spade 7;<br>
......<br>
<br>
&nbsp;&nbsp;&nbsp; 
这个过程和电影里间谍破密码倒是满象的。假如把它叫做“空当接龙工具1.0&quot;传上互联网，会有什么评价？估计比“国产游戏”好不了多少。<br>
&nbsp;&nbsp;&nbsp; 
不管怎么说，当时我根本就没想到要把这个程序公开。这只不过是由于某一天怎么也解不开一道空当接龙题，一时气愤，花了两天写出来的。过程很简单：从我的“程序百宝箱”里挑出一个“通用搜索程序”，嗯，这是以前解华容道时编的，然后，数据结构、输入输出，编码调试，例行公事地炮制出一个Exe，哈哈，以后再也不怕空当接龙了！接下来，和其他的大小程序一样，就在我的硬盘上睡大觉了。<br>
&nbsp;&nbsp;&nbsp; 
直到有这么一天，我们宿舍和隔壁两个屋爆发了空当接龙荣誉之战。很自然地，我拍拍胸脯，拿出了秘密武器。于是，一个人去掩上门（不能让人知道咱用了违禁物品），一个人读牌局，一个人输入。OK，输入完成！Save，Close，就等结果了。等等，这是什么？！<br>
<br>
Unreconized string:g0<br>
input file has some error.<br>
Do you want to reEdit it(y/n)?<br>
<br>
&nbsp;&nbsp;&nbsp; 
真是可恶，只好再输一次。还错！增加一个人手瞪大眼睛进行监督输入。总算对了。经过几十秒后，结果出来了。于是一个人念解，一个人操作空当接龙，才进行了一半，隔壁一位高手就完成了。秘密武器由于弹药装填太慢而宣告失败。<br>
&nbsp;&nbsp;&nbsp; 从这天起，我就考虑着怎样进行快速输入输出的问题了。曾经用FPE扫描内存，想直接从空当接龙程序的内存中读取数据，但是由于无法看透微软用的数据结构和不知道如何定位每次进程启动时不同的起始地址而宣告失败。<br>
一年过去了。这个问题已经被压进我记忆的堆栈的极深处，几乎就要忘了。<br>
&nbsp;&nbsp;&nbsp; 
有一天拿到一个程序，发现它检测某个软件是否安装在Windows里的方法就是查注册表，看看“Add/Remove”的登记项里是不是有特定的字符串。没有任何预兆，空当接龙的输入输出问题从记忆深处弹出来了。一个软件，不管内部如何复杂，最后总要以某种规范的方式进行输入输出。对操作系统，必须按规定操作开始菜单、注册表、INI文件等；对用户以人能够理解的方式进行输出，以人能够操作的方式接受输入。而且这种输入输出必须是简单明了、而且是有固定模式的。没有必要一定要深入到核心层，直接利用软件的输入输出系统就可以了。<br>
想到了这一层，解决方案几乎是立刻就出来了。用截屏的方式直接读取程序的窗口内容，然后分析其模式，还原成数据结构。然后，向程序发送鼠标键盘消息，就好像是人在操作一样。<br>
&nbsp;&nbsp;&nbsp; 
好了，有这几句话，接下去的具体实现过程都可以用省略号来代替了。我立刻动手，写了自动扫雷0.5（这也是未曾发表的版本）。因为扫雷比空当接龙的界面要简单很多，所以先从扫雷下手。验证了想法完全可行之后，先再接再厉，完成了自动扫雷1.0（期间总结出了两条扫雷万能秘诀：最多-最少-点开、最少-最多-标记，这是意外收获），然后，用了一个寒假的除了打游戏外的所有上机时间，做出了一个新版本的空当接龙工具。这个版本没有正式的版本号，暂且称为0.9吧。<br>
&nbsp;&nbsp;&nbsp; 
我是一个完美主义者，不漂亮的东西是不肯拿出手的。（事实上我硬盘上有好多好多可以称为“0.1”的程序，其中的解题类除了自动扫雷外，还有“华容道工具”、“四川省工具”、“独立钻石棋工具”等等。只缺“仓库番”工具了，请高手指教。）为了在网友面前有面子，只好把懒惰的习性暂时收敛。第一，设计了求解结果显示方法。现在的用不同颜色的线框表示移动和用灰色斑点表示自动取出的牌的方法是第三稿。第二，把相同布局仅仅列的次序不同的牌局归为一类，这样可以大幅度减少搜索的状态空间，但是这样需要加写整理算法和还原算法。第三，增加“超长整列移动”操作，把游戏中允许的若干个整列移动合并为一个高级操作，这充分利用了每一个空列，解决了0.1版中解题临近成功时有一段相当长的“团团转”的过程。这需要加写合并判断和分拆算法。第四，研究清楚游戏中小牌是怎样自动取出的，以便精确预测游戏的状态，使自动操作不至于失败。第五，反复试验了几十种参数配置，以使几乎每一局都可以在尽可能短的时间里解开。第六，增加了搜索算法的随机选项，解决了固定搜索算法在某几局无法在可接受的时间里完成的问题。第七，增加批量求解和记录的功能，以便在睡觉的时候也能让机器对大量牌局进行测试。第八，增加搜索过程中按取出牌数或空出列数进行显示的选项。第九，自动操作功能。第十，增加了“跟踪前进”功能，使看解时使游戏保持同步。……（按照我写毕业论文的笔法，以上十点可以写出十大章，可惜不能真的当论文写来挣学分:(）总之，使出了浑身解数。另外还使了一点小心眼：第十一，做了一个封面，把自己的名字放在上面。第十二，做了一个注册系统，以吸引用户反馈。（真是矛盾啊，想免费，但是这样用户就懒得理你，扫雷俄罗斯就是这样。）<br>
&nbsp;&nbsp;&nbsp; 
0.9完成了，为了保险起见，先散发给同学们试用。感谢顾彬同学，报告了一个天大的Bug：在Win98下自动操作失败！（我是在Win95下工作的。）赶紧查，原来Win98下的Freecell.exe里一些用词和Win95的不同。这好办，把对应的部分换掉就行了。其他地方顺利通过，可是在对应对话框标题“选定游戏号”的地方却老是出问题。折腾了半天终于有了结果，差点鼻子没气歪了：Win98下面的Freecell.exe中，字符串“选定游戏号”并不存在，而是“选定游戏号\r\n”！就是这两个看不见的字符跟我大捉迷藏，对话框标题还搞什么回车换行！打倒微软！<br>
总而言之，历尽千辛万苦，空当接龙工具1.0终于诞生了。这时是1999年3月，离0.1版已有一年半的时间了。<br>
<br>
&nbsp;&nbsp;&nbsp; 
最后再写些题外话。一是我关于空当接龙的研究结果：从1#到32000#的所有牌局，除了11982#外全部有解，而11982#可以用空当接龙工具证明无解。其中31465#异常地难，谁要是能手工解出，一定是个天才。<br>
&nbsp;&nbsp;&nbsp; 
二是解题所用的算法，也就是前面提到的“通用搜索程序”。其实算法本身并无神秘之处，事实上是人工智能领域中大名鼎鼎的“A*算法”，其思想是为每一个已经搜索到的状态进行评价，然后优先扩展评价最高的状态。关键在于如何对状态进行评价。在空当接龙工具中，我采取的评价方案考虑了已取出的牌数、空列数、左上角的空位数、整个牌局的有序程度这些因素。</font></p>

</body>

</html>
